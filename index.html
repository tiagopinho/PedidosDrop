<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Pedidos Shopee - Agrupados por Rastreio</title>

<style>
  body {
    font-family: Calibri, sans-serif;
    margin: 40px;
    background: #f7f7f7;
  }

  h2 { margin-bottom: 20px; }

  .rastreio-box {
    background: #fff;
    padding: 15px;
    margin-bottom: 25px;
    border-radius: 8px;
    border: 1px solid #ccc;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }

  table { border-collapse: collapse; width: 100%; table-layout: fixed; }
  th, td { border: 1px solid #ccc; padding: 6px; }
  th { background: #eee; }

  input, textarea {
    width: 100%;
    border: none;
    padding: 6px;
    box-sizing: border-box;
    font-family: inherit;
  }

  textarea { resize: none; overflow: hidden; }

  .not-found { background: #ffd6d6; }

  button {
    margin-top: 10px;
    padding: 8px 16px;
    cursor: pointer;
    border: none;
    border-radius: 4px;
  }

  .add-rastreio { background: #2196f3; color: white; }
  .salvar { background: #673ab7; color: white; }

  .col-qtd { width: 10%; max-width: 60px; text-align: center; }
  .col-sku { width: 20%; max-width: 150px; }

  /* ========= CORRIGIDO: TELA ========= */
  .col-produto { width: 70% !important; }
  .col-rastreio { width: 30% !important; }

  td input.qtd { text-align: center; }

  .rastreio-input {
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 8px;
    font-weight: bold;
    text-align: center;
  }

  /* ============================
         ESTILOS PARA IMPRESSÃƒO
     ============================ */
  @media print {

    body {
      margin: 0;
      background: white;
    }

    thead { display: none !important; }

    .col-qtd,
    .col-sku,
    td:nth-child(1),
    td:nth-child(2) {
      display: none !important;
    }

    button,
    #addRastreioBtn,
    #salvarBtn,
    #printBtn {
      display: none !important;
    }

    .rastreio-box {
      box-shadow: none !important;
      border: none !important;
      border-radius: 0 !important;
      padding: 0 !important;
      margin-bottom: 20px !important;
    }

    table {
      border-collapse: collapse !important;
      width: 100% !important;
      font-size: 14px;
    }

    th, td {
      border: 1px solid #000 !important;
      padding: 6px !important;
    }

    textarea, input {
      border: none !important;
      white-space: pre-wrap !important;
    }

    /* ========= CORRIGIDO: IMPRESSÃƒO ========= */
    th.col-produto,
    td:nth-child(3) { 
      width: 75% !important; 
    }
    
    th.col-rastreio,
    td:nth-child(4),
    td.td-rastreio { 
      width: 25% !important; 

  }
</style>
</head>

<body>

<h2>Gerador de Pedidos Shopee (Agrupado por Rastreio)</h2>

<div id="rastreiosContainer"></div>

<button id="addRastreioBtn" class="add-rastreio">+ Novo Rastreio</button>
<button id="salvarBtn" class="salvar">Salvar novos produtos no GitHub</button>
<button id="printBtn" class="salvar" style="background:#009688;">ðŸ–¨ Imprimir pedidos</button>

<script>

let produtos = [];

fetch("date.json")
  .then(r => r.json())
  .then(d => produtos = d)
  .catch(() => produtos = []);

/* Criar grupo */
function criarRastreio(valor="") {

  const wrapper = document.createElement("div");
  wrapper.className = "rastreio-box";

  wrapper.innerHTML = `
    <table>
      <thead>
        <tr>
          <th class="col-qtd">QTD</th>
          <th class="col-sku">SKU</th>
          <th class="col-produto">PRODUTO</th>
          <th class="col-rastreio">CÃ“D. RASTREIO</th>
        </tr>
      </thead>

      <tbody class="tbody-group">
        <tr>
          <td><input type="number" class="qtd"></td>
          <td><input type="text" class="sku"></td>
          <td><textarea class="produto" rows="1"></textarea></td>
          <td class="td-rastreio" rowspan="1">
            <input type="text" class="rastreio-input rastreio" value="${valor}" placeholder="Ex: BR250982724238Q">
          </td>
        </tr>
      </tbody>
    </table>
  `;

  document.getElementById("rastreiosContainer").appendChild(wrapper);

  const tbody = wrapper.querySelector(".tbody-group");
  const rastreioTd = wrapper.querySelector(".td-rastreio");


  /* AUTOEXPAND */
  wrapper.addEventListener("input", e => {
    if (e.target.classList.contains("produto")) {
      e.target.style.height = "auto";
      e.target.style.height = e.target.scrollHeight + "px";
    }
  });


  /* CRIA LINHA NOVA */
  wrapper.addEventListener("input", e => {

    if (!["qtd", "sku", "produto"].includes(e.target.classList[0])) return;

    const linha = e.target.closest("tr");
    const ultima = tbody.lastElementChild;

    if (linha === ultima && e.target.value.trim() !== "") {

      const nova = ultima.cloneNode(true);
      nova.querySelectorAll("input,textarea").forEach(el => el.value = "");

      if (nova.querySelector(".td-rastreio"))
        nova.querySelector(".td-rastreio").remove();

      tbody.appendChild(nova);
      rastreioTd.rowSpan = tbody.querySelectorAll("tr").length;
    }

  });


  /* AUTOPREENCHER PRODUTO */
  wrapper.addEventListener("blur", e => {

    if (!e.target.classList.contains("sku")) return;

    const sku = e.target.value.trim().toLowerCase();
    const row = e.target.closest("tr");
    const campoProduto = row.querySelector(".produto");
    const qtdDigitada = Number(row.querySelector(".qtd")?.value || 1);

    if (!sku) return;

    const encontrado = produtos.find(p => p.sku?.toLowerCase() === sku);

    if (!encontrado) {
      campoProduto.value = "";
      campoProduto.classList.add("not-found");
      return;
    }

    campoProduto.classList.remove("not-found");

    const linhas = encontrado.produto.replace(/\\n/g, "\n").split("\n");

    campoProduto.value = linhas
      .map(l => {
        const m = l.match(/^(\d+)\s*-\s*(.+)$/);
        if (!m) return l;
        return `${Number(m[1]) * qtdDigitada} - ${m[2]}`;
      })
      .join("\n");

    campoProduto.style.height = "auto";
    campoProduto.style.height = campoProduto.scrollHeight + "px";

  }, true);

}

/* Criar primeiro bloco */
criarRastreio();

/* Novo rastreio */
document.getElementById("addRastreioBtn")
  .addEventListener("click", () => criarRastreio());

/* BOTÃƒO IMPRIMIR â€” remove linhas vazias antes de imprimir */
document.getElementById("printBtn").addEventListener("click", () => {

  document.querySelectorAll("tbody tr").forEach(tr => {
    const prod = tr.querySelector(".produto")?.value.trim();
    const sku = tr.querySelector(".sku")?.value.trim();
    const qtd = tr.querySelector(".qtd")?.value.trim();

    if (!prod && !sku && !qtd) tr.style.display = "none";
  });

  window.print();
});

</script>

</body>
</html>
